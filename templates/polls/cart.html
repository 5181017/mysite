{% extends "polls/menu.html" %}
{% load static %}

{% block style %}
  <link rel="stylesheet" type="text/css" href= "{% static 'polls/css/cart.css' %}">
{% endblock %}

{% block menu %}
<form action="cart" method="post">
    {% csrf_token %}
    <div class="mainForm">
        {% for item in list %}
          <div class="itemForm">
              <input name="checkbox" class="checkBox" type="checkbox" value="{{ item.productid.productID}}" onchange='calcMoney();checkChecked()'>
            <div class="element">
              <div style="width: 100%; height: 100%; background-color: aquamarine;">画像</div>
            </div>
            <div class="element">
              <div style="width: 100%; height: 100%; background-color: aqua;">{{ item.name }}</div>
            </div>
            <div class="element" style="background-color: aquamarine;">
              <div class="verticalForm">

                  <input name="{{ item.productid.productID}}" id="{{ item.productid.productID}}" type="hidden" value="{{ item.quantity }}">
                  <div class="priceQuantity" style="background-color: thistle;">
                      <div style="display: flex; margin-left: 50%; margin-right: 50%; margin-top:30px; ">
                      <div id="minus" style="background: gray; font-size: 30px; padding: 5px; cursor: pointer;" onclick="quantityMinus('{{ item.productid.productID}}')">-</div>
                        <div name="name_{{ item.productid.productID}}">{{ item.quantity }}</div>
                      <div id="plus" style="background: gray; font-size: 30px;padding: 5px; cursor: pointer;" onclick="quantityPlus('{{ item.productid.productID}}')">+</div>
                      </div>
                  </div>

                  <input name="money" type="hidden" value="{{ item.price }}">
                <div class="priceQuantity" style="background-color: tan;">{{ item.price }}円</div>
              </div>
            </div>
          </div>
        {% endfor %}
    </div>


    <div class="money_form" name="moneyForm">
      <div class="buy_form_move">
        <input name="total_money" class="move_form" type="text" placeholder="合計" id="sumMoney" value="0">
        <input id="pay-btn" name="pay_btn" class="move_form" type="submit" value="購入に進む"style="width:150px; min-width:150px;" disabled>
      </div>
    </div>
    </form>


    <script>
    {#金額の計算#}


        function calcMoney(){
            var checkBox = document.getElementsByName("checkbox")
            var sumMoney = document.getElementById("sumMoney")
            var money = document.getElementsByName("money")
            var quantity


            var total = 0

            for(let i = 0; i < checkBox.length; i++){
                quantity = document.getElementById(checkBox[i].value).value
                 total = (parseInt(money[i].value , 10) * quantity) + total
                if(!checkBox[i].checked){
                    total = total - parseInt(money[i].value , 10) * quantity
                }
            }
            sumMoney.value = String(total)
        }

        function checkChecked(){
            var checkBox = document.getElementsByName("checkbox")
            var submitBtn = document.getElementById("pay-btn")

            for(let i = 0; i < checkBox.length; i++) {
                if(checkBox[i].checked){
                    submitBtn.disabled = false
                }else{
                    submitBtn.disabled = true
                }
            }
        }

        
        function quantityMinus( product_id) {
            var quantity_div = document.getElementsByName("name_" + product_id)
            var quantity_input = document.getElementById(product_id)
            var quantity = quantity_input.value

            quantity = String(parseInt(quantity, 10) - 1)
            quantity = Math.max(1 , quantity)

            quantity_input.value = quantity
            quantity_div[0].innerHTML = quantity

            calcMoney(quantity)
        }

        function quantityPlus(product_id) {
            var quantity_div = document.getElementsByName("name_" + product_id)
            var quantity_input = document.getElementById(product_id)
            var quantity = quantity_input.value

            quantity = String(parseInt(quantity, 10) + 1)
            quantity = Math.max(1 , quantity)

            quantity_input.value = quantity
            quantity_div[0].innerHTML = quantity

            calcMoney(quantity)
        }

    </script>
{% endblock %}

